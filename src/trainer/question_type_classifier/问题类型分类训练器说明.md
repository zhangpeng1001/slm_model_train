# 问题类型分类训练器

## 概述

问题类型分类训练器是基于BERT模型的二分类器，用于识别用户提问的意图类型：
- **问题回答**：用户想要获取信息、知识或解答
- **任务处理**：用户想要执行某个具体操作或处理任务

## 功能特点

- 基于bert-base-chinese预训练模型
- 二分类任务：问题回答 vs 任务处理
- 支持CPU训练和推理
- 提供训练、评估、预测功能
- 支持批量预测和交互式测试

## 文件结构

```
src/trainer/question_type_classifier/
├── __init__.py                                    # 模块初始化
├── question_type_classifier_trainer.py           # 训练器核心实现
├── question_type_classifier_train_and_test.py    # 训练和测试脚本
└── 问题类型分类训练器说明.md                      # 说明文档
```

## 训练数据样例

### 问题回答类型（类别0）
用户想要获取信息、知识或解答的问题：
- "我有一批西安市地类图斑的数据，怎么进行发服务"
- "DEM高程数据怎么进行质量检查"
- "矢量地形图数据如何入库"
- "卫星遥感数据的预处理流程是什么"
- "无人机航拍数据如何进行几何纠正"

### 任务处理类型（类别1）
用户想要执行某个具体操作或处理任务：
- "请帮我把实景三维模型成果数据进行治理"
- "我已经上传了单波段浮点投影的数据，现在想进行入库"
- "有一些遥感影像数据需要处理"
- "正射影像数据需要进行坐标转换"
- "激光雷达数据进行格式转换"

## 使用方法

### 1. 训练模型

```bash
# 直接运行训练脚本（默认训练模式）
python src/trainer/question_type_classifier/question_type_classifier_train_and_test.py

# 或者指定训练模式
python src/trainer/question_type_classifier/question_type_classifier_train_and_test.py --mode train
```

### 2. 测试模型

```bash
# 测试已训练的模型
python src/trainer/question_type_classifier/question_type_classifier_train_and_test.py --mode test

# 指定模型路径测试
python src/trainer/question_type_classifier/question_type_classifier_train_and_test.py --mode test --model_path ./path/to/model
```

### 3. 交互式测试

```bash
# 启动交互式测试
python src/trainer/question_type_classifier/question_type_classifier_train_and_test.py --mode interactive
```

### 4. 代码调用示例

```python
from src.trainer.question_type_classifier.question_type_classifier_trainer import QuestionTypeClassifierTrainer

# 初始化训练器
model_path = "path/to/bert-base-chinese"
trainer = QuestionTypeClassifierTrainer(model_path)

# 训练模型
trainer.train(epochs=5, batch_size=4, learning_rate=2e-5)

# 保存模型
trainer.save_model('question_type_classifier')

# 预测单个文本
result = trainer.predict("我有一些数据需要处理")
print(f"预测类型: {result['predicted_type']}")
print(f"置信度: {result['confidence']:.4f}")

# 批量预测
texts = ["如何进行数据清洗？", "请帮我处理这些数据"]
results = trainer.batch_predict(texts)
```

## 训练参数

- **epochs**: 训练轮次，默认5
- **batch_size**: 批次大小，默认4（CPU训练建议使用较小值）
- **learning_rate**: 学习率，默认2e-5
- **max_length**: 最大序列长度，默认128

## 输出格式

预测结果包含以下信息：
```python
{
    'text': '输入文本',
    'predicted_type': '问题回答' 或 '任务处理',
    'confidence': 0.9876,  # 置信度
    'probabilities': {
        '问题回答': 0.1234,
        '任务处理': 0.8766
    }
}
```

## 模型保存路径

训练完成的模型默认保存在：
```
src/train_data/trained_question_type_classifier/question_type_classifier/
├── config.json
├── pytorch_model.bin
├── tokenizer_config.json
├── vocab.txt
├── special_tokens_map.json
└── label_map.json
```

## 性能评估

训练过程中会输出：
- 每个epoch的平均损失
- 准确率
- 分类报告（精确率、召回率、F1分数）
- 混淆矩阵

## 注意事项

1. **模型路径配置**：请确保BERT模型路径正确配置
2. **内存使用**：CPU训练时建议使用较小的batch_size
3. **数据平衡**：训练数据中两个类别的样本数量基本平衡
4. **文本长度**：输入文本会被截断或填充到max_length长度

## 扩展功能

### 添加新的训练数据
在`prepare_training_data()`方法中添加新的样本：

```python
# 问题回答类型样本
question_answer_samples.extend([
    "新的问题回答样本1",
    "新的问题回答样本2"
])

# 任务处理类型样本
task_processing_samples.extend([
    "新的任务处理样本1",
    "新的任务处理样本2"
])
```

### 调整模型参数
可以通过修改训练参数来优化模型性能：

```python
trainer.train(
    epochs=10,        # 增加训练轮次
    batch_size=8,     # 调整批次大小
    learning_rate=1e-5  # 调整学习率
)
```

## 故障排除

1. **模型路径错误**：检查BERT模型是否正确下载到指定路径
2. **内存不足**：减小batch_size或max_length
3. **训练不收敛**：调整学习率或增加训练轮次
4. **预测准确率低**：增加训练数据或调整模型参数

## 更新日志

- v1.0: 初始版本，支持基本的训练和预测功能
- 支持问题回答和任务处理二分类
- 提供完整的训练、测试和交互式功能
