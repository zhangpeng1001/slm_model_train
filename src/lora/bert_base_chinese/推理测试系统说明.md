# PEFT LoRA 数据平台推理测试系统

## 概述

基于已训练的PEFT LoRA模型，实现完整的数据平台智能问答推理系统。系统按照预定义的流程进行推理：

1. **问题场景分类** - 判断问题是否与数据平台相关
2. **问题类型分类** - 对数据平台相关问题进行进一步分类
3. **具体处理** - 根据问题类型执行相应的处理逻辑

## 系统架构

### 核心组件

1. **DataPlatformInferenceSystem** - 主推理系统
   - 模型加载和管理
   - 4种推理功能实现
   - 完整的问题处理流程

2. **InferenceTestRunner** - 测试运行器
   - 场景测试
   - 单步功能测试
   - 交互式测试

## 4种场景处理流程

### 场景1: 数据平台相关问题 - 问题回答类型
```
用户问题 → 场景分类(数据平台相关) → 类型分类(问题回答) → 调用问题回答模块 → 返回答案
```

**示例问题:**
- "数据清洗流程是什么？"
- "如何进行数据入库？"
- "数据质量检查包括哪些内容？"

### 场景2: 数据平台相关问题 - 任务处理类型
```
用户问题 → 场景分类(数据平台相关) → 类型分类(任务处理) → 提取文件名称 → 返回处理确认
```

**示例问题:**
- "请帮我把实景三维模型成果数据进行治理"
- "我有一批西安市地类图斑的数据，怎么进行发服务"
- "DEM高程数据需要进行质量检查"

### 场景3: 通用问题
```
用户问题 → 场景分类(通用问题) → 返回通用回复
```

**示例问题:**
- "你好"
- "谢谢"
- "再见"

### 场景4: 无关问题
```
用户问题 → 场景分类(无关问题) → 提示用户咨询数据平台相关问题
```

**示例问题:**
- "今天天气怎么样？"
- "推荐一部电影"
- "如何学习英语？"

## 文件结构

```
src/lora/bert_base_chinese/
├── peft_lora_data_platform.py     # 训练代码
├── dataset.py                     # 训练数据集
├── inference_test.py              # 完整推理测试系统
├── test_inference_simple.py       # 简单测试脚本
└── 推理测试系统说明.md            # 本文档
```

## 使用方法

### 1. 环境准备

确保已安装必要的依赖：
```bash
pip install torch transformers peft
```

### 2. 模型路径配置

在代码中配置正确的模型路径：
```python
bert_model_path = r"E:\project\llm\model-data\base-models\models--bert-base-chinese\snapshots\8f23c25b06e129b6c986331a13d8d025a92cf0ea"
lora_model_path = r"E:\project\llm\lora\peft_lora_data_platform"
```

### 3. 运行测试

#### 方式1: 完整测试系统
```bash
python inference_test.py
```

提供4种测试模式：
1. 完整场景测试 - 测试所有4种场景的预定义用例
2. 单步功能测试 - 分别测试各个功能模块
3. 交互式测试 - 手动输入问题进行测试
4. 退出

#### 方式2: 简单测试
```bash
python test_inference_simple.py
```

快速验证系统是否能正常工作。

### 4. 编程接口使用

```python
from inference_test import DataPlatformInferenceSystem

# 初始化系统
inference_system = DataPlatformInferenceSystem(
    model_path=lora_model_path,
    bert_model_path=bert_model_path
)

# 处理单个问题
result = inference_system.process_question("数据清洗流程是什么？")

# 查看结果
print(f"场景: {result['scenario']}")
print(f"类型: {result['question_type']}")
print(f"回复: {result['response']}")
```

## 推理流程详解

### 1. 问题场景分类
```python
scenario = inference_system.classify_question_scenario(question)
# 返回: "数据平台相关问题" | "通用问题" | "无关问题"
```

### 2. 问题类型分类（仅数据平台相关问题）
```python
question_type = inference_system.classify_question_type(question)
# 返回: "问题回答" | "任务处理"
```

### 3. 问题回答
```python
answer = inference_system.answer_question(question)
# 返回具体的问题答案
```

### 4. 文件名提取
```python
filename = inference_system.extract_filename(question)
# 返回从问题中提取的文件名称
```

## 输出格式

完整处理结果包含以下字段：
```python
{
    "question": "用户问题",
    "scenario": "问题场景分类结果",
    "question_type": "问题类型分类结果（可选）",
    "response": "最终回复",
    "filename": "提取的文件名（可选）",
    "processing_steps": ["处理步骤列表"]
}
```

## 测试用例

### 数据平台相关问题 - 问题回答
- "数据清洗流程是什么？"
- "如何进行数据入库？"
- "数据质量检查包括哪些内容？"
- "数据监控怎么做？"
- "如何保证数据安全？"

### 数据平台相关问题 - 任务处理
- "请帮我把实景三维模型成果数据进行治理"
- "我有一批西安市地类图斑的数据，怎么进行发服务"
- "我已经上传了单波段浮点投影的数据，现在想进行入库"
- "有一些遥感影像数据需要处理"
- "DEM高程数据需要进行质量检查"

### 通用问题
- "你好"
- "您好，请问"
- "谢谢你的帮助"
- "再见"
- "早上好"

### 无关问题
- "今天天气怎么样？"
