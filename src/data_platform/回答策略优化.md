需求设计文档（数据平台智能问答系统-输入噪声拦截与拒答策略优化）

一、背景与问题
- 背景：src/data_platform 是数据平台智能问答系统，基于知识库与 BERT 语义匹配返回业务数据。
- 问题：当前系统对随意输入的噪声字符串（如“123abc”）也可能返回业务数据，属于误答，影响可信度与用户体验。
- 根因分析：
  1) simple_qa_model.py 语义相似度阈值较低（默认 0.7），导致随机/噪声输入也可能越过阈值。
  2) 缺少输入合法性校验与统一拒答策略，所有输入都会进入匹配流程。
- 目标：对明显非业务输入（噪声、无关、含极少中文等）直接拒答；语义匹配需提高阈值与稳定性，避免误答。

二、总体方案
- 方案要点（最小侵入改造）：
  1) 输入合法性校验：新增 _is_noise_query 规则，拦截噪声输入（如 123abc、纯英文/数字/标点、极短文本等）。
  2) 动态相似度阈值：根据输入中文字符数与是否包含业务关键词，动态调高阈值（最高 0.92），减少非中文/无关键词的误匹配。
  3) Top-2 一致性检验：当 best_sim 与 second_sim 分差过小且整体分不高时，视为不稳定匹配，拒答。
  4) 统一拒答文案：对无效输入或低置信度匹配，返回明确的拒答提示，不返回业务数据。
- 回退模式兼容：当 BERT 初始化失败时系统退回 knowledge_base，仅做直接关键词匹配，此时噪声输入不会返回业务数据（会返回默认拒答）。

三、改动范围与具体实现
- 文件：src/data_platform/simple_qa_model.py
  1) 新增 import re
  2) 新增方法：
     - _count_chinese_chars：统计中文字符数量
     - _has_business_keyword：基于知识库 key 检测业务关键词
     - _is_noise_query：输入噪声判定
       规则概述：
       - 过短文本（长度 < 2）直接视为噪声
       - 仅由 ASCII 字母数字/常见符号组成且无中文/无关键词视为噪声
       - 仅标点组成视为噪声
       - 高比例 ASCII 字母数字（>80%）且无中文/无关键词视为噪声
       - 若中文字符数 ≥ 2 或包含业务关键词，放行进入后续流程
  3) find_most_similar_question：
     - 默认阈值从 0.7 提升至 0.8
     - 返回 best_sim 与 second_sim，供一致性检验
  4) answer_question 流程：
     - 第一步：调用 _is_noise_query，噪声输入直接返回 method=invalid_input，confidence=0.0，不进入匹配
     - 第二步：尝试 knowledge_base 直接匹配，匹配到返回 confidence=1.0
     - 第三步：动态阈值：
       - 非中文且无关键词：0.92（严格）
       - 中文少且无关键词：0.85（偏严格）
       - 默认：0.80（正常）
     - 第四步：Top-2 一致性检验。当 (best_sim - second_sim) < 0.05 且 best_sim < 0.90 时拒答
     - 其他情况：正常返回语义匹配结果
- 文件：src/data_platform/qa_system.py
  - 无需修改逻辑。当前打印逻辑对 invalid_input 与 no_match 会展示统一拒答答案，不展示匹配信息，符合期望。
- 文件：src/data_platform/knowledge_base.py
  - 保持不变。其默认返回的拒答文案将作为知识库-only 模式的兜底，不会对噪声输入返回业务数据。

四、关键阈值与策略说明
- 输入噪声识别：
  - 栗子：123abc、test123、----、... 等均会被 _is_noise_query 拦截。
  - 对至少包含两个中文字符或包含知识库关键词的输入认为“可能有效”，进入匹配流程。
- 动态阈值：
  - 非中文且无关键词：0.92
  - 无关键词但中文较少：0.85
  - 其他：0.80
- 一致性检验：
  - 若最佳与次佳相似度分差 < 0.05 且最佳分值 < 0.90，判定为不稳定匹配，统一拒答。

五、用户交互与返回
- 对噪声输入（invalid_input）：
  - 返回 answer：“抱歉，未能识别您的问题。请用数据平台相关的业务术语重新提问，例如：数据入库流程、任务调度、数据安全等。”
  - method：invalid_input
  - confidence：0.0
- 对无法匹配（no_match）：
  - 返回知识库统一拒答：“抱歉，我无法回答这个问题。请尝试询问关于数据清洗、数据入库、数据处理、数据监控或数据安全相关的问题。”
  - method：no_match
  - confidence：0.0
- 对直接匹配（direct_match）：
  - confidence：1.0
- 对语义匹配（semantic_match）：
  - 返回 matched_question 与 confidence

六、测试用例（验收标准）
- 无意义输入应拒答
  - 输入：123abc、----、......、test123、_._、a1b2c3
  - 预期：method ∈ {invalid_input, no_match}；不返回业务数据
- 过短输入应拒答
  - 输入：a、1、?、哈
  - 预期：invalid_input/no_match
- 正常中文业务问题应回答
  - 输入：数据入库流程、任务调度怎么做、数据安全包含哪些措施
  - 预期：direct_match 或 semantic_match，返回对应业务答案
- 边界场景
  - 输入：数据清洗（中文较短但业务强相关）
  - 预期：可能 direct_match（若命中子串）或 semantic_match，取决于知识库 key
  - 输入：data 安全（中英混杂）
  - 预期：若包含“安全”等关键词，可进入匹配；否则需满足阈值才会返回，否则拒答
- 回退模式（BERT 初始化失败）
  - 预期：仅知识库直接匹配，不会对 123abc 返回业务数据

七、风险与权衡
- 适度提高阈值可能导致少量“边缘问题”被拒答（召回下降），但显著降低误答（精度提升）。
- _is_noise_query 规则需保持简单可维护，后续可抽象为配置或策略插件，便于迭代。

八、后续可配置化建议（非本次必做）
- 将阈值与规则参数化（如噪声比例、长度阈值、相似度阈值、分差阈值等），统一置于配置文件。
- 引入基于词典的领域关键词扩充或通过 TF-IDF 对中文少的输入做快速过滤。
- 增加日志埋点：记录 invalid_input/no_match 的样本，便于持续优化。

九、变更清单
- 代码改动：
  - src/data_platform/simple_qa_model.py：新增输入噪声过滤、动态阈值、一致性检验、问题归一化；阈值默认提升到 0.8。
  - src/data_platform/knowledge_base.py：新增业务意图触发词映射、常见后缀模糊匹配，增强中文自然表达的匹配。
- 未改动文件：
  - src/data_platform/qa_system.py、src/data_platform/start_qa.py（保持不变）
- 变更策略遵循：注意清理不需要的代码，但不动不相关范围内的代码。

十、回滚方案
- 如需回滚：将 simple_qa_model.py 恢复至变更前版本即可（建议通过 Git 版本管理进行回退）。

十一、使用与验证
- 启动命令（项目根目录）：
  - python -u src/data_platform/start_qa.py
- 快速验证：
  1) 输入 123abc、----、test123，预期拒答
  2) 输入 数据入库流程，预期返回正确业务数据
  3) 输入 数据安全，预期返回对应业务数据
  4) 输入 data 安全，检查是否能合理匹配，若不稳定则拒答

结论
- 本次优化在不影响现有业务问答能力的前提下，提升了系统对噪声/无意义输入的拦截能力，并通过动态阈值与一致性检验减少了误答，符合“随便字符不应该返回业务数据”的诉求。
