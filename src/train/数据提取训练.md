# 数据提取训练器使用说明

## 概述

数据提取训练器是基于BERT模型的命名实体识别(NER)系统，专门用于从用户问题中提取数据类型信息。该训练器使用BIO标注方法，能够识别和提取问题中的关键数据类型实体。

## 功能特点

- **基于BERT模型**: 使用bert-base-chinese预训练模型
- **BIO标注**: 采用标准的BIO标注方法进行实体识别
- **数据增强**: 自动生成训练样本变体，提高模型泛化能力
- **CPU优化**: 专门针对CPU环境进行优化
- **实体提取**: 从用户问题中准确提取数据类型信息

## 文件结构

```
src/train/
├── data_extraction_trainer.py          # 主训练器类
├── data_extraction_train_and_test.py   # 训练和测试脚本
└── DATA_EXTRACTION_README.md           # 使用说明文档
```

## 训练样本示例

训练器包含丰富的训练样本，涵盖各种数据类型：

| 用户问题 | 提取结果 |
|---------|---------|
| 我有一批西安市地类图斑的数据，怎么进行发服务 | 西安市地类图斑 |
| 请帮我把实景三维模型成果数据进行治理 | 实景三维模型成果 |
| 我已经上传了单波段浮点投影的数据，现在想进行入库 | 单波段浮点投影 |
| 有一些遥感影像数据需要处理 | 遥感影像 |
| DEM高程数据怎么进行质量检查 | DEM高程 |

## 使用方法

### 1. 训练模型

```bash
# 训练数据提取模型
python data_extraction_train_and_test.py --mode train
```

训练参数：
- epochs: 8轮训练
- batch_size: 2 (适合CPU训练)
- learning_rate: 1e-5

### 2. 测试模型

```bash
# 使用预设测试样本测试
python data_extraction_train_and_test.py --mode test

# 使用指定的训练好的模型测试
python data_extraction_train_and_test.py --mode test --model_path ./trained_data_extractors/final_data_extractor
```

### 3. 交互式测试

```bash
# 交互式测试，可以输入自定义问题
python data_extraction_train_and_test.py --mode interactive
```

### 4. 直接运行训练器

```bash
# 直接运行主训练器
python data_extraction_trainer.py
```

## 代码使用示例

### 基本使用

```python
from data_extraction_trainer import DataExtractionTrainer

# 初始化训练器
model_path = "path/to/bert-base-chinese"
trainer = DataExtractionTrainer(model_path)

# 训练模型
trainer.train(epochs=6, batch_size=2, learning_rate=1e-5)

# 提取数据类型
question = "我有一批遥感影像数据需要处理"
result = trainer.extract_data_from_question(question)
print(f"提取结果: {result['main_data_type']}")
```

### 加载训练好的模型

```python
# 加载已训练的模型
trainer.load_model("./trained_data_extractors/final_data_extractor")

# 进行预测
result = trainer.extract_data_from_question("DEM高程数据怎么入库？")
```

## 模型架构

### BertDataExtractionModel

- **输入层**: BERT tokenizer编码
- **编码层**: BERT模型提取特征
- **分类层**: 线性层进行BIO标注分类
- **输出**: 3个类别 (O, B-DATA, I-DATA)

### 标签定义

- **O**: 其他字符 (Outside)
- **B-DATA**: 数据类型实体开始 (Begin)
- **I-DATA**: 数据类型实体内部 (Inside)

## 训练数据

训练器包含38个基础样本，通过数据增强生成更多训练样本：

### 数据类型覆盖

- 地理信息数据：地类图斑、DEM高程、矢量地形图等
- 遥感数据：卫星遥感、无人机航拍、正射影像等
- 三维数据：实景三维模型、点云、城市三维建模等
- 专业数据：激光雷达、倾斜摄影测量、地质勘探等
- 监测数据：环境监测、交通流量、水文监测等

### 数据增强策略

对每个基础样本生成10个变体：
- "如何处理{数据类型}数据？"
- "{数据类型}数据怎么入库？"
- "我需要对{数据类型}数据进行处理"
- 等等...

## 评估指标

- **Token级别准确率**: 基于BIO标注的分类准确率
- **实体级别准确率**: 完整实体提取的准确率
- **分类报告**: 详细的精确率、召回率、F1分数

## 模型保存

训练过程中会自动保存：
- **检查点**: 每2个epoch保存一次
- **最终模型**: 训练完成后保存
- **配置文件**: 模型配置和标签映射

保存内容：
```
trained_data_extractors/
├── final_data_extractor/
│   ├── pytorch_model.bin    # 模型权重
│   ├── config.json         # 模型配置
│   ├── tokenizer_config.json # tokenizer配置
│   └── vocab.txt           # 词汇表
```

## 性能优化

- **CPU优化**: 强制使用CPU，适合无GPU环境
- **小批次**: 使用较小的batch_size减少内存占用
- **梯度累积**: 通过多个小批次模拟大批次训练
- **学习率调度**: 使用线性warmup调度器

## 注意事项

1. **模型路径**: 确保BERT模型路径正确
2. **内存管理**: CPU训练时注意内存使用
3. **训练时间**: CPU训练可能需要较长时间
4. **数据质量**: 训练样本的质量直接影响模型效果

## 扩展功能

### 添加新的数据类型

```python
# 在prepare_training_data方法中添加新样本
new_samples = [
    ("新的问题文本", "要提取的数据类型"),
    # 更多样本...
]
```

### 自定义数据增强

```python
# 在_
